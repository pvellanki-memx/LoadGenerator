PostgreSQL Database Schema Design
Tables Overview:

Trades: Stores detailed information about each trade.
Orders: Stores order details, including attempts that may not result in trades.
Alerts: Logs alerts generated by the surveillance engine.
Audit: Tracks changes and actions taken within the system.
Users: Manages user information and roles.
Schema Details:

Trades Table:

trade_id: Primary Key
security_id: Foreign Key (links to Securities table)
broker_id: Foreign Key (links to Brokers table)
trade_volume: Integer
trade_price: Decimal
timestamp: DateTime
Orders Table:

order_id: Primary Key
security_id: Foreign Key
broker_id: Foreign Key
order_type: Text (e.g., buy, sell)
order_volume: Integer
order_price: Decimal
status: Text (e.g., executed, cancelled)
timestamp: DateTime
Alerts Table:

alert_id: Primary Key
type: Text (e.g., spoofing, wash sale)
description: Text
relevant_trade_id: Foreign Key (links to Trades table)
relevant_order_id: Foreign Key (links to Orders table)
timestamp: DateTime
Audit Table:

audit_id: Primary Key
user_id: Foreign Key (links to Users table)
action: Text
description: Text
timestamp: DateTime
Users Table:

user_id: Primary Key
username: Text
role: Text
password_hash: Text
Indexes:

Indexes on timestamp fields in Trades, Orders, and Alerts tables for faster query performance.
Indexes on security_id and broker_id in Trades and Orders to speed up joins and searches.
Security:

Implement role-based access control at the database level.
Use encryption for sensitive data like password_hash in Users table.
Performance Considerations:

Use partitioning on the Trades and Orders tables based on timestamp to manage large datasets efficiently.
Consider using connection pooling to manage database connections and optimize performance.












Real-Time Processing in Matching Engine
Real-time rules in the matching engine are typically simpler, faster to evaluate, and based on single transactions or very recent data patterns. These rules are designed to instantly identify potential issues as trades and orders occur.

High Order to Trade Ratio:

Detects abnormal order-to-trade ratios in real time as transactions occur, indicating potential market abuse like quote stuffing.
Rapid Entry and Delete (Spoofing):

Monitors for quick insertion and removal of large orders, which can distort market perception.
Order Withdrawal (Continuous):

Observes patterns of orders being repeatedly placed and then withdrawn before execution, potentially to manipulate the market.
High Order Rate:

Detects a high number of orders entered by a single participant within a short time frame, suggesting potential market manipulation or system errors.
High Small Order Rate:

Identifies excessive entry of small orders below a predefined threshold, which might indicate layering or other disruptive strategies.
Complex Analysis in Deephaven DB
Deephaven DB is used for more complex analyses that require historical data aggregation, pattern recognition over longer periods, or more detailed and computationally intensive calculations.

Phishing and Multi-Order Spoofing with Bait and Switch:

Analyzes sequences of small probing orders followed by large trades, or complex patterns of order additions and deletions followed by advantageous trades.
Unusual Price Movement Inter-Day and Unusual Volume Intra-Day:

Compares current trading patterns against historical data to detect anomalies in price movements or trading volumes over configurable time ranges.
Wash Sales A to B to A:

Identifies circular trading patterns that are intended to artificially inflate trade volumes or manipulate market prices.
Painting the Tape and Aggressive Buy or Sell:

Analyzes trading behavior that attempts to influence market prices through aggressive trading strategies.
Narrowing Spread Followed by Crossing:

Detects instances where the market spread is manipulated followed by trades that take advantage of the altered market condition.
Marking the Close (Non-Auction Close):

Monitors end-of-day trading to detect attempts to influence closing prices.



executions.csv

DeephavenPartitionID	SessionId	SourceId	Sequence	Timestamp	OptionId	UnderlyingSymbol	EFID	ExchangeOrderId	MatchId	ExecId	Side	ExecutionFlags	ExecutionPrice	ExecutionQuantity	TradeSequence	LiquidityCode	ExchangeCode	ActionableId	SubAccount	OptionalOCCData	GiveUp	CMTA	ClearingMemberNum	ContraEFID	ContraSubAccount	ContraGiveUp	ContraCMTA	PositionEffect
5/17/24	OM07.1715941582	MA07EN01	634,852,195	21:08.7	A1v8ae9t	AAPL	CEDL	576,572,902,503,587,000	576,572,902,489,457,000	576,572,902,517,799,000	Sell	0	0.09	2	8	Added	MXOP		CIT					DFIN			769	Unknown
5/17/24	OM07.1715941582	MA07EN01	634,852,194	21:08.7	A1v8ae9t	AAPL	DFIN	576,572,902,503,650,000	576,572,902,489,457,000	576,572,902,517,799,000	Buy	1	0.09	2	8	Removed	MXOP	664775e33c				769		CEDL	CIT			Open
5/17/24	OM07.1715941582	MA07EN13	634,455,572	21:03.8	R1OJ4T7a	RIOT	IBKR	576,538,817,634,517,000	576,538,817,628,995,000	576,538,817,640,012,000	Sell	0	2.78	1	3	Added	MXOP	U633243				534		CEDL	CIT			Open

accounts.csv
DeephavenPartitionID	SessionId	SourceId	Sequence	Timestamp	AccountId	FirmId	IsTest	IsActive	IsCancelInDisconnect	DefaultEFID	IsRiskIdFilteringEnabled	IsEFIDFilteringEnabled	IsMTPGroupIdFilteringEnabled	IsCancelGroupIdFilteringEnabled
5/17/24	OPCC.1715941588	ACCTSPIN	556	32:11.1	BOFAPDR1	BOFAOPT1	FALSE	TRUE	TRUE	MLCC	FALSE	TRUE	FALSE	FALSE
5/17/24	OPCC.1715941588	ACCTSPIN	559	32:11.1	BOFAPDR2	BOFAOPT1	FALSE	TRUE	TRUE	MLCC	FALSE	TRUE	FALSE	FALSE
5/17/24	OPCC.1715941588	ACCTSPIN	562	32:11.1	BOFAPDR3	BOFAOPT1	FALSE	TRUE	TRUE	MLCC	FALSE	TRUE	FALSE	FALSE

orderstate.csv
DeephavenPartitionID	SessionId	SourceId	Sequence	Timestamp	AccountId	RequestId	RequestEventType	ReasonCode	ReasonDetails	EFID	OptionId	UnderlyingSymbol
5/17/24	OM04.1715941572	MA04EN05	636,715,805	16:56.2	OPTIPE40	864,758,198,664,431,000	Accepted			OPTE	T28w0jel	TSLA
5/17/24	OM03.1715941569	MA03EN13	875,998,833	16:54.9	OPTIPE49	864,761,497,199,317,000	Accepted			OPTE	N1xA2UQE	NVDA
5/17/24	OM03.1715941569	MA03EN13	875,241,825	16:48.4	OPTIPE49	864,761,497,199,317,000	Accepted			OPTE	N1xA4jka	NVDA


efids.csv
DeephavenPartitionID	SessionId	SourceId	Sequence	Timestamp	EFID	FirmId	IsTest	IsActive	ClearingMemberNum
5/17/24	OPCC.1715941588	EFIDSPIN	382	32:11.0	BAMA	BOFAOPT1	FALSE	TRUE	161
5/17/24	OPCC.1715941588	EFIDSPIN	383	32:11.0	BAMB	BOFAOPT1	FALSE	TRUE	792
5/17/24	OPCC.1715941588	EFIDSPIN	384	32:11.0	MLCC	BOFAOPT1	FALSE	TRUE	792
5/17/24	OPCC.1715941588	EFIDSPIN	385	32:11.0	MLCO	BOFAOPT1	FALSE	TRUE	161


firms.csv
DeephavenPartitionID	SessionId	SourceId	Sequence	Timestamp	FirmId	InstitutionName	IsActive	IsMarketMaker	CanRouteOrders	AggregationId	CRDNumber	OrderEntryStreamIndex
5/17/24	OPCC.1715941588	FIRMSPIN	351	32:10.8	BELVOPT1	Belvedere Trading LLC	TRUE	TRUE	TRUE	0	132,605	13
5/17/24	OPCC.1715941588	FIRMSPIN	352	32:10.8	BOFAOPT1	BofA Securities, Inc.	TRUE	FALSE	TRUE	0	283,942	13
5/17/24	OPCC.1715941588	FIRMSPIN	353	32:10.8	CITAOPR1	Citadel Securities LLC	TRUE	FALSE	TRUE	0	116,797	13
5/17/24	OPCC.1715941588	FIRMSPIN	354	32:10.8	CITAOPT1	Citadel Securities LLC	TRUE	TRUE	TRUE	0	116,797	11
